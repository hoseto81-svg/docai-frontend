<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocAI - AI-Powered Document Processing</title>

    <!-- Tailwind (CDN) ‚Äì –æ–∫ –∑–∞ –ø—Ä–æ—Ç–æ—Ç–∏–ø / –¥–µ–º–æ -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PDF libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.js"></script>

    <!-- Excel library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        .uploading {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800 mb-2">DocAI</h1>
            <p class="text-xl text-gray-600">AI-Powered Document Processing</p>
        </header>

        <!-- Upload / Processing Section -->
        <main class="space-y-10">

            <!-- Upload Section -->
            <section id="uploadSection" class="max-w-2xl mx-auto">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div
                        id="dropZone"
                        class="border-4 border-dashed border-gray-300 rounded-xl p-12 text-center hover:border-blue-500 transition-colors cursor-pointer"
                    >
                        <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        <p class="text-xl text-gray-700 mb-2">Drag &amp; Drop —Ñ–∞–∫—Ç—É—Ä–∞ —Ç—É–∫</p>
                        <p class="text-gray-500 mb-4">–∏–ª–∏</p>
                        <label
                            for="fileInput"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 cursor-pointer inline-block transition-colors"
                        >
                            –ò–∑–±–µ—Ä–∏ —Ñ–∞–π–ª
                        </label>
                        <input type="file" id="fileInput" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                        <p class="text-sm text-gray-500 mt-4">
                            –ü–æ–¥–¥—ä—Ä–∂–∞–Ω–∏: PDF, JPG, PNG ‚Ä¢ –ú–∞–∫—Å: 10MB
                        </p>
                    </div>

                    <div id="selectedFile" class="mt-4 hidden">
                        <p class="text-gray-700">
                            –ò–∑–±—Ä–∞–Ω —Ñ–∞–π–ª:
                            <span id="fileName" class="font-semibold"></span>
                        </p>
                        <button
                            id="uploadBtn"
                            class="w-full mt-4 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors text-lg font-semibold"
                        >
                            üöÄ –û–±—Ä–∞–±–æ—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                        </button>
                    </div>

                    <div id="uploadStatus" class="mt-4 text-sm text-gray-500 hidden"></div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="resultSection" class="hidden">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-3">
                            <div class="h-10 w-10 rounded-full bg-green-100 flex items-center justify-center">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                            <div>
                                <p class="text-lg font-semibold text-gray-800">–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–µ–Ω</p>
                                <p id="resultFileName" class="text-sm text-gray-500"></p>
                            </div>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button
                                id="exportPdfBtn"
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors text-sm font-semibold"
                            >
                                –ò–∑—Ç–µ–≥–ª–∏ PDF
                            </button>
                            <button
                                id="exportExcelBtn"
                                class="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors text-sm font-semibold"
                            >
                                –ò–∑—Ç–µ–≥–ª–∏ Excel
                            </button>
                            <button
                                id="newDocBtn"
                                class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors text-sm font-semibold"
                            >
                                –ù–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç
                            </button>
                        </div>
                    </div>

                    <!-- Invoice Summary -->
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-2">
                            <h2 class="text-lg font-semibold text-gray-800">–î–∞–Ω–Ω–∏ –∑–∞ —Ñ–∞–∫—Ç—É—Ä–∞</h2>
                            <p class="text-sm text-gray-600">
                                <span class="font-semibold">–§–∞–∫—Ç—É—Ä–∞ ‚Ññ:</span>
                                <span id="invoiceNumber"></span>
                            </p>
                            <p class="text-sm text-gray-600">
                                <span class="font-semibold">–î–∞—Ç–∞:</span>
                                <span id="invoiceDate"></span>
                            </p>
                        </div>
                        <div class="space-y-2">
                            <h2 class="text-lg font-semibold text-gray-800">–°—Ç–æ–π–Ω–æ—Å—Ç–∏</h2>
                            <p class="text-sm text-gray-600">
                                <span class="font-semibold">–ë–µ–∑ –î–î–°:</span>
                                <span id="subtotal"></span>
                            </p>
                            <p class="text-sm text-gray-600">
                                <span class="font-semibold">–î–î–°:</span>
                                <span id="vat"></span>
                            </p>
                            <p class="text-sm text-gray-800">
                                <span class="font-semibold">–û–±—â–æ:</span>
                                <span id="total"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Vendor / Client -->
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-1">
                            <h3 class="text-md font-semibold text-gray-800">–î–æ—Å—Ç–∞–≤—á–∏–∫</h3>
                            <p id="vendorName" class="text-sm text-gray-700"></p>
                            <p id="vendorAddress" class="text-sm text-gray-600"></p>
                            <p id="vendorVat" class="text-sm text-gray-600"></p>
                        </div>
                        <div class="space-y-1">
                            <h3 class="text-md font-semibold text-gray-800">–ö–ª–∏–µ–Ω—Ç</h3>
                            <p id="clientName" class="text-sm text-gray-700"></p>
                            <p id="clientAddress" class="text-sm text-gray-600"></p>
                            <p id="clientVat" class="text-sm text-gray-600"></p>
                        </div>
                    </div>

                    <!-- Items Table (HTML view only) -->
                    <div>
                        <h3 class="text-md font-semibold text-gray-800 mb-3">–ê—Ä—Ç–∏–∫—É–ª–∏</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left border border-gray-200 rounded-lg overflow-hidden">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="px-3 py-2 border-b border-gray-200">‚Ññ</th>
                                        <th class="px-3 py-2 border-b border-gray-200">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                                        <th class="px-3 py-2 border-b border-gray-200">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                        <th class="px-3 py-2 border-b border-gray-200">–ï–¥. —Ü–µ–Ω–∞</th>
                                        <th class="px-3 py-2 border-b border-gray-200">–û–±—â–æ</th>
                                    </tr>
                                </thead>
                                <tbody id="itemsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div id="notesSection" class="mt-6 hidden">
                        <h3 class="text-md font-semibold text-gray-800 mb-1">–ë–µ–ª–µ–∂–∫–∞</h3>
                        <p id="invoiceNotes" class="text-sm text-gray-600"></p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- –û—Å–Ω–æ–≤–µ–Ω JS (–ß–∞—Å—Ç 3) -->
    <script>
    // –ì–ª–æ–±–∞–ª–Ω–∞ –ø—Ä–æ–º–µ–Ω–ª–∏–≤–∞, –∞–∫–æ –±–µ–∫–µ–Ω–¥—ä—Ç –Ω–µ —è –¥–µ—Ñ–∏–Ω–∏—Ä–∞ ‚Äì –¥–∞ –Ω–µ –≥—ä—Ä–º–∏
    if (typeof resultsData === "undefined") {
        window.resultsData = null;
    }

    /* ---------------------------------------------------------
       UI –ª–æ–≥–∏–∫–∞ –∑–∞ upload (–º–∏–Ω–∏–º–∞–ª–Ω–∞, –±–µ–∑ –±–µ–∫–µ–Ω–¥ –ª–æ–≥–∏–∫–∞)
    --------------------------------------------------------- */
    const fileInput = document.getElementById("fileInput");
    const dropZone = document.getElementById("dropZone");
    const selectedFileDiv = document.getElementById("selectedFile");
    const fileNameSpan = document.getElementById("fileName");
    const uploadBtn = document.getElementById("uploadBtn");
    const uploadStatus = document.getElementById("uploadStatus");

    const resultSection = document.getElementById("resultSection");
    const uploadSection = document.getElementById("uploadSection");

    let selectedFile = null;

    dropZone.addEventListener("click", () => fileInput.click());

    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("border-blue-500", "bg-blue-50");
    });

    dropZone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-50");
    });

    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-500", "bg-blue-50");
        const file = e.dataTransfer.files[0];
        handleFileSelect(file);
    });

    fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        handleFileSelect(file);
    });

    function handleFileSelect(file) {
        if (!file) return;
        selectedFile = file;
        fileNameSpan.textContent = file.name;
        selectedFileDiv.classList.remove("hidden");
    }

    uploadBtn.addEventListener("click", async () => {
        if (!selectedFile) return;

        uploadStatus.classList.remove("hidden");
        uploadStatus.textContent = "–û–±—Ä–∞–±–æ—Ç–≤–∞–Ω–µ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞...";
        uploadStatus.classList.add("uploading");

        try {
            // –¢—É–∫ –≤–∫–ª—é—á–≤–∞—à —Ä–µ–∞–ª–Ω–∏—è —Å–∏ API call –∫—ä–º –±–µ–∫–µ–Ω–¥–∞.
            // –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω–æ: –∏–∑–ø–æ–ª–∑–≤–∞–º–µ resultsData, –∞–∫–æ –≤–µ—á–µ –µ –ø–æ–ø—ä–ª–Ω–µ–Ω –æ—Ç –±–µ–∫–µ–Ω–¥–∞.
            if (!resultsData || !resultsData.extraction || !resultsData.extraction.data) {
                uploadStatus.textContent = "–ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –¥–∞–Ω–Ω–∏ –æ—Ç AI –æ–±—Ä–∞–±–æ—Ç–∫–∞.";
                uploadStatus.classList.remove("uploading");
                return;
            }

            populateInvoiceUI(resultsData.extraction.data, resultsData.file_name);

            uploadSection.classList.add("hidden");
            resultSection.classList.remove("hidden");
            uploadStatus.classList.add("hidden");
            uploadStatus.classList.remove("uploading");
        } catch (err) {
            console.error(err);
            uploadStatus.textContent = "–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞—Ç–∞.";
            uploadStatus.classList.remove("uploading");
        }
    });

    document.getElementById("newDocBtn").addEventListener("click", () => {
        // Reset UI –∑–∞ –Ω–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç
        selectedFile = null;
        fileInput.value = "";
        fileNameSpan.textContent = "";
        selectedFileDiv.classList.add("hidden");
        resultSection.classList.add("hidden");
        uploadSection.classList.remove("hidden");
    });

    function populateInvoiceUI(invoice, fileName) {
        document.getElementById("resultFileName").textContent = fileName || "";

        document.getElementById("invoiceNumber").textContent = invoice.invoice_number || "";
        document.getElementById("invoiceDate").textContent = invoice.date || "";

        if (invoice.totals) {
            document.getElementById("subtotal").textContent =
                (invoice.totals.subtotal ?? "") + " " + (invoice.currency || "BGN");
            document.getElementById("vat").textContent =
                (invoice.totals.vat_amount ?? "") + " " + (invoice.currency || "BGN");
            document.getElementById("total").textContent =
                (invoice.totals.total ?? "") + " " + (invoice.currency || "BGN");
        }

        if (invoice.vendor) {
            document.getElementById("vendorName").textContent = invoice.vendor.name || "";
            document.getElementById("vendorAddress").textContent = invoice.vendor.address || "";
            document.getElementById("vendorVat").textContent = invoice.vendor.vat_number
                ? "–ï–ò–ö: " + invoice.vendor.vat_number
                : "";
        }

        if (invoice.client) {
            document.getElementById("clientName").textContent = invoice.client.name || "";
            document.getElementById("clientAddress").textContent = invoice.client.address || "";
            document.getElementById("clientVat").textContent = invoice.client.vat_number
                ? "–ï–ò–ö: " + invoice.client.vat_number
                : "";
        }

        const itemsBody = document.getElementById("itemsTableBody");
        itemsBody.innerHTML = "";
        (invoice.items || []).forEach((item, idx) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="px-3 py-2 border-b border-gray-200">${idx + 1}</td>
                <td class="px-3 py-2 border-b border-gray-200">${item.description || ""}</td>
                <td class="px-3 py-2 border-b border-gray-200">${item.quantity ?? ""}</td>
                <td class="px-3 py-2 border-b border-gray-200">${item.unit_price ?? ""}</td>
                <td class="px-3 py-2 border-b border-gray-200">${item.total ?? ""}</td>
            `;
            itemsBody.appendChild(tr);
        });

        if (invoice.notes) {
            document.getElementById("invoiceNotes").textContent = invoice.notes;
            document.getElementById("notesSection").classList.remove("hidden");
        } else {
            document.getElementById("notesSection").classList.add("hidden");
        }
    }

    /* ---------------------------------------------------------
       –ó–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –ª–æ–∫–∞–ª–Ω–∏ Arimo —à—Ä–∏—Ñ—Ç–æ–≤–µ –∑–∞ jsPDF 1.5.3
    --------------------------------------------------------- */
    async function loadFont(url) {
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error("–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —à—Ä–∏—Ñ—Ç: " + url);
        }

        const buffer = await response.arrayBuffer();
        let binary = "";
        const bytes = new Uint8Array(buffer);

        for (let i = 0; i < bytes.byteLength; i++) {
            binary += String.fromCharCode(bytes[i]);
        }

        return btoa(binary);
    }

    async function registerFonts() {
        const regular = await loadFont("fonts/Arimo-Regular.ttf");
        const bold = await loadFont("fonts/Arimo-Bold.ttf");
        const italic = await loadFont("fonts/Arimo-Italic.ttf");

        jsPDF.API.addFileToVFS("Arimo-Regular.ttf", regular);
        jsPDF.API.addFont("Arimo-Regular.ttf", "Arimo", "normal");

        jsPDF.API.addFileToVFS("Arimo-Bold.ttf", bold);
        jsPDF.API.addFont("Arimo-Bold.ttf", "Arimo", "bold");

        jsPDF.API.addFileToVFS("Arimo-Italic.ttf", italic);
        jsPDF.API.addFont("Arimo-Italic.ttf", "Arimo", "italic");
    }

    /* ---------------------------------------------------------
       EXPORT PDF ‚Äì –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∞ —Ñ–∞–∫—Ç—É—Ä–∞
    --------------------------------------------------------- */
    document.getElementById("exportPdfBtn").addEventListener("click", async () => {
        if (!resultsData || !resultsData.extraction || !resultsData.extraction.data) {
            alert("–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ PDF.");
            return;
        }

        const invoice = resultsData.extraction.data;

        try {
            await registerFonts();
        } catch (e) {
            console.error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —à—Ä–∏—Ñ—Ç–æ–≤–µ—Ç–µ:", e);
            alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ —à—Ä–∏—Ñ—Ç–æ–≤–µ—Ç–µ –∑–∞ PDF.");
            return;
        }

        const doc = new jsPDF();

        // –ó–∞–≥–ª–∞–≤–∏–µ
        doc.setFont("Arimo", "bold");
        doc.setFontSize(22);
        doc.text("–§–∞–∫—Ç—É—Ä–∞", 14, 20);

        // –û—Å–Ω–æ–≤–Ω–∏ –¥–∞–Ω–Ω–∏
        doc.setFont("Arimo", "normal");
        doc.setFontSize(12);
        doc.text("–§–∞–∫—Ç—É—Ä–∞ ‚Ññ: " + (invoice.invoice_number || "N/A"), 14, 35);
        doc.text("–î–∞—Ç–∞: " + (invoice.date || "N/A"), 14, 42);

        // –î–æ—Å—Ç–∞–≤—á–∏–∫
        doc.setFont("Arimo", "bold");
        doc.text("–î–æ—Å—Ç–∞–≤—á–∏–∫:", 14, 55);

        doc.setFont("Arimo", "normal");
        doc.text(invoice.vendor?.name || "", 14, 62);
        doc.text(invoice.vendor?.address || "", 14, 68);
        if (invoice.vendor?.vat_number) {
            doc.text("–ï–ò–ö: " + invoice.vendor.vat_number, 14, 74);
        }

        // –ö–ª–∏–µ–Ω—Ç
        doc.setFont("Arimo", "bold");
        doc.text("–ö–ª–∏–µ–Ω—Ç:", 110, 55);

        doc.setFont("Arimo", "normal");
        doc.text(invoice.client?.name || "", 110, 62);
        doc.text(invoice.client?.address || "", 110, 68);
        if (invoice.client?.vat_number) {
            doc.text("–ï–ò–ö: " + invoice.client.vat_number, 110, 74);
        }

        // –¢–∞–±–ª–∏—Ü–∞ —Å –∞—Ä—Ç–∏–∫—É–ª–∏
        const items = (invoice.items || []).map((item, index) => [
            index + 1,
            item.description || "",
            item.quantity ?? "",
            item.unit_price ?? "",
            item.total ?? ""
        ]);

        doc.autoTable({
            startY: 90,
            head: [["‚Ññ", "–û–ø–∏—Å–∞–Ω–∏–µ", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–ï–¥. —Ü–µ–Ω–∞", "–û–±—â–æ"]],
            body: items,
            styles: { font: "Arimo", fontSize: 10 },
            headStyles: { fillColor: [66, 66, 66], textColor: 255, fontStyle: "bold" }
        });

        // –û–±–æ–±—â–µ–Ω–∏–µ
        let finalY = doc.autoTable.previous ? doc.autoTable.previous.finalY + 10 : 90;

        doc.setFont("Arimo", "bold");
        doc.text("–û–±–æ–±—â–µ–Ω–∏–µ:", 14, finalY);

        doc.setFont("Arimo", "normal");
        const currency = invoice.currency || "BGN";

        if (invoice.totals) {
            doc.text("–ë–µ–∑ –î–î–°: " + (invoice.totals.subtotal ?? "") + " " + currency, 14, finalY + 8);
            doc.text("–î–î–° (" + (invoice.totals.vat_rate ?? "") + "%): " +
                     (invoice.totals.vat_amount ?? "") + " " + currency,
                     14, finalY + 16);
            doc.text("–û–±—â–æ: " + (invoice.totals.total ?? "") + " " + currency, 14, finalY + 24);
        }

        // Notes (–∞–∫–æ –∏–º–∞)
        if (invoice.notes) {
            doc.setFont("Arimo", "italic");
            doc.setFontSize(11);
            doc.text("–ë–µ–ª–µ–∂–∫–∞: " + invoice.notes, 14, finalY + 36);
        }

        // Footer
        doc.setFont("Arimo", "italic");
        doc.setFontSize(10);
        doc.setTextColor(120);
        doc.text("–î–æ–∫—É–º–µ–Ω—Ç—ä—Ç –µ –æ–±—Ä–∞–±–æ—Ç–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç hoseto.cloud", 14, 285);

        const filename = "faktura_" + (invoice.invoice_number || "document") + ".pdf";
        doc.save(filename);
    });

    /* ---------------------------------------------------------
       EXPORT EXCEL ‚Äì –ø—ä–ª–µ–Ω —Ñ–æ—Ä–º–∞—Ç
    --------------------------------------------------------- */
    document.getElementById("exportExcelBtn").addEventListener("click", () => {
        if (!resultsData || !resultsData.extraction || !resultsData.extraction.data) {
            alert("–ù—è–º–∞ –¥–∞–Ω–Ω–∏ –∑–∞ Excel.");
            return;
        }

        const invoice = resultsData.extraction.data;
        const sheet = [];

        sheet.push(["–§–∞–∫—Ç—É—Ä–∞"]);
        sheet.push([]);
        sheet.push(["–§–∞–∫—Ç—É—Ä–∞ ‚Ññ", invoice.invoice_number || ""]);
        sheet.push(["–î–∞—Ç–∞", invoice.date || ""]);
        sheet.push(["–í–∞–ª—É—Ç–∞", invoice.currency || ""]);
        sheet.push([]);

        sheet.push(["–î–æ—Å—Ç–∞–≤—á–∏–∫"]);
        sheet.push(["–ò–º–µ", invoice.vendor?.name || ""]);
        sheet.push(["–ê–¥—Ä–µ—Å", invoice.vendor?.address || ""]);
        sheet.push(["–ï–ò–ö", invoice.vendor?.vat_number || ""]);
        sheet.push([]);

        sheet.push(["–ö–ª–∏–µ–Ω—Ç"]);
        sheet.push(["–ò–º–µ", invoice.client?.name || ""]);
        sheet.push(["–ê–¥—Ä–µ—Å", invoice.client?.address || ""]);
        sheet.push(["–ï–ò–ö", invoice.client?.vat_number || ""]);
        sheet.push([]);

        sheet.push(["–ê—Ä—Ç–∏–∫—É–ª–∏"]);
        sheet.push(["‚Ññ", "–û–ø–∏—Å–∞–Ω–∏–µ", "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", "–ï–¥. —Ü–µ–Ω–∞", "–û–±—â–æ"]);

        (invoice.items || []).forEach((item, index) => {
            sheet.push([
                index + 1,
                item.description || "",
                item.quantity ?? "",
                item.unit_price ?? "",
                item.total ?? ""
            ]);
        });

        sheet.push([]);
        sheet.push(["–û–±–æ–±—â–µ–Ω–∏–µ"]);
        if (invoice.totals) {
            sheet.push(["–ë–µ–∑ –î–î–°", invoice.totals.subtotal ?? ""]);
            sheet.push(["–î–î–°", invoice.totals.vat_amount ?? ""]);
            sheet.push(["–û–±—â–æ", invoice.totals.total ?? ""]);
        }

        const worksheet = XLSX.utils.aoa_to_sheet(sheet);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Invoice");

        const filename = "faktura_" + (invoice.invoice_number || "document") + ".xlsx";
        XLSX.writeFile(workbook, filename);
    });
    </script>
</body>
</html>
